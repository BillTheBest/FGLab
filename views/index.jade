extends ./layout.jade

block title
  title FGLab

block content
  .row
    .col-sm-6
      h1 #[span.mega-octicon.octicon-clippy] Projects
      h2 New Project
      form#new-project
        fieldset.form-group
          label(for="schema") Project schema
          input#schema.form-control-file(name="schema", type="file")
          small.text-muted Upload a valid project schema. The name of the JSON file will be used to name the project.
        button.btn.btn-primary(type="submit") Create Project

      br
      h2 Existing Projects
      table#projects.table
        thead
          tr
            th
            th ID
            th Name
            th Experiment
            th Hyperparamater Optimisation
            th Results
        tbody
          - each project in projects
            tr
              th
                button.btn.btn-danger-outline.btn-sm.delete(data-type="projects", data-id="#{project._id}", type="button") #[span.octicon.octicon-trashcan]
              th #{project._id}
              th #{project.name}
              th 
                a(href="/projects/" + project._id)
                  button.btn.btn-primary-outline.btn-sm(type="button") #[span.octicon.octicon-diff-added]
              th 
                a(href="/projects/" + project._id + "/optimisation")
                  button.btn.btn-primary-outline.btn-sm(type="button") #[span.octicon.octicon-circuit-board]
              th 
                a(href="/projects/" + project._id + "/experiments")
                  button.btn.btn-primary-outline.btn-sm(type="button") #[span.octicon.octicon-clippy]

    .col-sm-6
      h1 #[span.mega-octicon.octicon-server] Machines
      ul#machines.list-unstyled
        - each machine in machines
          li
            button.btn.btn-danger-outline.btn-sm.delete(data-type="machines", data-id="#{machine._id}", type="button") #[span.octicon.octicon-trashcan]
            | &nbsp;
            a(href="/machines/" + machine._id) #{machine.hostname}

block scripts
  script(src="/bower_components/jquery/dist/jquery.min.js")
  script.
    $(function() {
      // Make home button active
      $("#nav .nav-item:first-child").addClass("active");

      // Create new project
      $("#new-project").on("submit", function() {
        // Extract file
        var fd = new FormData($(this)[0]);
        // Send
        $.ajax({
          url: "/api/projects/schema",
          type: "POST",
          data: fd,
          processData: false,
          contentType: false
        })
        .then(function() {
          location.reload(); // Refresh page
        });
        return false; // Stop event and propagation
      });

      // Delete project or machine
      $("button.delete").on("click", function() {
        var $el = $(this);
        var type = $el.data("type");
        var id = $el.data("id");

        if (type === "projects") {
          // Delete experiment files
          $.ajax({
            url: "/api/projects/" + id + "/experiments/files",
            type: "DELETE"
          })
          .then(function() {
            // Then delete experiments
            $.ajax({
              url: "/api/projects/" + id + "/experiments",
              type: "DELETE"
            })
            .then(function() {
              // Then delete project
              $.ajax({
                url: "/api/projects/" + id,
                type: "DELETE"
              })
              .then(function() {
                location.reload(); // Refresh page
              })
              .catch(function(err) {
                console.log(err);
              });
            });
          })
          .catch(function(err) {
            console.log(err);
          });
        } else {
          // Delete machine
          $.ajax({
            url: "/api/machines/" + id,
            type: "DELETE"
          })
          .then(function() {
            location.reload(); // Refresh page
          })
          .catch(function(err) {
            console.log(err);
          });
        }
        return false; // Stop event and propagation
      });
    });
