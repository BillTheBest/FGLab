doctype html
html(lang="en")
  head
    title FGLab - Project #{project.name}
    script(src="/javascripts/jquery.min.js")
  body
    h1 Project: #{project.name} (#{project._id})
    h2 New Experiment
    form#new-experiment
      each val, key in project.schema
        if (val.type === "int")
          .form-group
            label(for="#{key}") #{key}
            | &nbsp;
            input(type="number", value="#{val.default}", name="#{key}", required)
        else if (val.type === "float")
          .form-group
            label(for="#{key}") #{key}
            | &nbsp;
            input(type="number", value="#{val.default}", step="any", name="#{key}", required)
        else if (val.type === "bool")
          .form-group
            label(for="#{key}") #{key}
            | &nbsp;
            input(type="text", value="#{val.default}", pattern="(true|false)", title="Enter true or false", name="#{key}", required)
        else if (val.type === "string")
          .form-group
            label(for="#{key}") #{key}
            | &nbsp;
            input(type="text", value="#{val.default}", name="#{key}", required)
        else if (val.type === "enum")
          .form-group
            label(for="#{key}") #{key}
            select(name="#{key}")
              each value in val.values
                if (value === val.default)
                  option(value="#{value}", selected="selected") #{value}
                else
                  option(value="#{value}") #{value}
      button(type="submit") Start Experiment

    h2 Experiments
    ul
      - each experiment in experiments
        li
          a(href="/experiments/" + experiment._id) #{experiment._id}
          | &nbsp;
          a(href="/api/experiments/" + experiment._id, class="delete") (delete)

    script.
      $(function() {
        // Creates new experiment
        $("#new-experiment").on("submit", function() {
          var formObj = {};
          // Loop over form simply (does not work on nested data)
          $(this).find(":input").not(":submit").each(function(ind, el) {
            var $el = $(el);
            var name = $el.attr("name");
            var val = $el.val();
            // Test for bools
            if ($el.attr("pattern")) {
              val = (val === "true");
            }
            formObj[name] = val; // Set key and value
          });

          $.ajax({
            url: "/new-experiment/#{project._id}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formObj)
          }).
          then(function() {
            location.reload(); // TODO Move to new experiment page
          });
          return false; // Stop event and propagation
        });

        // Deletes existing experiment
        $("a.delete").on("click", function() {
          $.ajax({
            url: $(this).attr("href"),
            type: "DELETE"
          })
          .then(function() {
            location.reload(); // Refresh page
          });
          return false; // Stop event and propagation
        });
      });
